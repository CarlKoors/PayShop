const { token, apiKey, port } = require('./config.json');
const express = require('express');
const app = express();

const customFooter = 'iOFF: Togglable Production';
const { Client, GatewayIntentBits, EmbedBuilder, Partials } = require('discord.js');
const client = new Client({intents: [GatewayIntentBits.DirectMessages, GatewayIntentBits.DirectMessageReactions, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent, GatewayIntentBits.Guilds, GatewayIntentBits.GuildMembers], partials: [Partials.Message, Partials.Channel, Partials.Reaction, Partials.GuildMember, Partials.User, Partials.ThreadMember]});

app.post('/', (req, res) => {
  client.login(token).catch(console.error);
  let discord, prodcut, cmd;
  
  console.log(req.data, req.headers, req.query, req.body);
  
  if (req.headers.apikey === null && req.query.apiKey === null) return res.sendStatus(401);
  if (req.headers.apikey != apiKey && req.query.apiKey != apiKey) return res.sendStatus(401);
  
  if (req.query.apiKey === apiKey) { // we are using a url params likely sell app or shoppy
	discord = req.query.discord; // <- must be handled differently
    product = req.query.pid;
    cmd = req.query.cmd;
  }
  
  if (req.headers.apikey === apiKey) { // paybot should be the only intagration capable of this
	discord = req.query.discord;
    product = req.query.pid;
    cmd = req.query.cmd;
  }
  if(req.headers.apikey != null) {
    discord = req.headers.discord;
    product = req.headers.pid;
    cmd = req.headers.cmd;
  } 
  
  if (cmd==='getProduct') {
    for (let i=0;i<require('./products.json').products.length;i++) if (require('./products.json').products[i].id == product) return res.send(require('./products.json').products[i].Title+':'+require('./products.json').products[i].Price);
    return res.sendStatus(404); // not found
  }
  
  // Now we can handle Paybot & Sell.app (sellix or whatever the fuck you want).
  
  if (cmd==='itemsold') return res.send(''+itemSold(discord, product)+'');
  return res.sendStatus(403);
  
});

app.listen(port, () => console.log('Alive on http://{ipaddress}:'+port));


function getExpirationDate(days) {
  if (days === '1d') days = 1;
  if (days === '1w') days = 14;
  if (days === '1m') days = 30;
  if (days === '1y') days = 365;
  date = new Date();
  date.setDate(date.getDate()+Number(days));
  return date.getTime();
}

function itemSold(discord, product) {
	x=-1;
	let jData;
    for (let i=0;i<require('./products.json').products.length;i++) if (require('./products.json').products[i].id == product) x=i;
    if (x===-1) return false;

    const p = require('./products.json').products[x];
    if (p.Type === 'subscription') jData = getExpirationDate(p.Term); // you can use really anything here
    require('./Modules/jDbs.js').edit(p.id, discord, jData); // it goes database(aka a folder), key(aka discordId.json), value(jsondata)
    require('./Modules/msg.js').sendEmbed(client, discord, client.user.username, client.user.avatarURL(),
	'Thank you for Purchasing', p.Title, p.Thumbnail, customFooter, 'Product-ID '+p.id, 'Price $'+p.Price+'  :dollar:');
}
